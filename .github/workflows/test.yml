name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Code Quality (Linting)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install flake8
        run: pip install flake8
      
      - name: Run linting
        run: |
          flake8 src/ tests/ main.py --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ tests/ main.py --count --max-line-length=100 --statistics --exclude=__pycache__,.pytest_cache,vector_index

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run pytest
        run: pytest tests/ -v --tb=short
      
      - name: Check test coverage
        run: pytest tests/ --cov=src --cov-report=term-missing

  verify-knowledge-base:
    name: Verify Knowledge Base
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Count documents
        run: |
          DOC_COUNT=$(ls -1 knowledge_base/*.txt 2>/dev/null | wc -l)
          echo "Found $DOC_COUNT documents in knowledge base"
          if [ "$DOC_COUNT" -lt 4 ]; then
            echo "Error: Need at least 4 documents"
            exit 1
          fi
          echo "Document count requirement met"
      
      - name: Verify document format
        run: |
          echo "Checking document metadata headers..."
          ERROR=0
          for file in knowledge_base/*.txt; do
            if [ -f "$file" ]; then
              if ! head -1 "$file" | grep -q "^---"; then
                echo "Error: $file missing metadata header"
                ERROR=1
              else
                echo "$file has valid metadata header"
              fi
            fi
          done
          if [ $ERROR -eq 1 ]; then
            exit 1
          fi
          echo "All documents have proper metadata headers"
      
      - name: Verify word count
        run: |
          echo "Checking document word counts..."
          ERROR=0
          for file in knowledge_base/*.txt; do
            if [ -f "$file" ]; then
              WORDS=$(wc -w < "$file")
              echo "$file: $WORDS words"
              if [ $WORDS -lt 300 ]; then
                echo "Error: $file has fewer than 300 words"
                ERROR=1
              fi
            fi
          done
          if [ $ERROR -eq 1 ]; then
            exit 1
          fi
          echo "All documents meet minimum word count"

  check-structure:
    name: Verify Project Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check required directories
        run: |
          echo "Checking project structure..."
          ERROR=0
          for dir in src tests knowledge_base .github/workflows; do
            if [ -d "$dir" ]; then
              echo "$dir/ exists"
            else
              echo "$dir/ missing"
              ERROR=1
            fi
          done
          if [ $ERROR -eq 1 ]; then
            exit 1
          fi
      
      - name: Check required files
        run: |
          echo "Checking required files..."
          ERROR=0
          for file in README.md requirements.txt main.py src/__init__.py tests/__init__.py; do
            if [ -f "$file" ]; then
              echo "$file exists"
            else
              echo "$file missing"
              ERROR=1
            fi
          done
          if [ $ERROR -eq 1 ]; then
            exit 1
          fi
      
      - name: Check Python modules
        run: |
          echo "Checking Python modules..."
          ERROR=0
          for module in src/loader.py src/embeddings.py src/vectorstore.py src/rag.py; do
            if [ -f "$module" ]; then
              echo "$module exists"
            else
              echo "$module missing"
              ERROR=1
            fi
          done
          if [ $ERROR -eq 1 ]; then
            exit 1
          fi
